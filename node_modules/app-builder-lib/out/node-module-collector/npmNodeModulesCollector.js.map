{"version":3,"file":"npmNodeModulesCollector.js","sourceRoot":"","sources":["../../src/node-module-collector/npmNodeModulesCollector.ts"],"names":[],"mappings":"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","sourcesContent":["import { NodeModulesCollector } from \"./nodeModulesCollector.js\"\nimport { PM } from \"./packageManager.js\"\nimport { NpmDependency } from \"./types.js\"\n\nexport class NpmNodeModulesCollector extends NodeModulesCollector<NpmDependency, string> {\n  public readonly installOptions = {\n    manager: PM.NPM,\n    lockfile: \"package-lock.json\",\n  }\n\n  protected getArgs(): string[] {\n    return [\"list\", \"-a\", \"--include\", \"prod\", \"--include\", \"optional\", \"--omit\", \"dev\", \"--json\", \"--long\", \"--silent\", \"--loglevel=error\"]\n  }\n\n  protected async collectAllDependencies(tree: NpmDependency) {\n    for (const [key, value] of Object.entries(tree.dependencies || {})) {\n      if (this.isDuplicatedNpmDependency(value)) {\n        continue\n      }\n      // Use the key (alias name) instead of value.name for npm aliased packages\n      // e.g., { \"foo\": { name: \"@scope/bar\", ... } } should be stored as \"foo@version\"\n      // This ensures aliased packages are copied to the correct location in node_modules\n      const normalizedDep: NpmDependency = key !== value.name ? { ...value, name: key } : value\n      this.allDependencies.set(this.packageVersionString(normalizedDep), normalizedDep)\n      await this.collectAllDependencies(value)\n    }\n  }\n\n  protected async extractProductionDependencyGraph(tree: NpmDependency, dependencyId: string): Promise<void> {\n    if (this.productionGraph[dependencyId]) {\n      return\n    }\n\n    const isDuplicateDep = this.isDuplicatedNpmDependency(tree)\n    const targetTree = isDuplicateDep ? this.allDependencies.get(dependencyId) : tree\n\n    // Initialize with empty dependencies array first to mark this dependency as \"in progress\"\n    // After initialization, if there are libraries with the same name+version later, they will not be searched recursively again\n    // This will prevents infinite loops when circular dependencies are encountered.\n    this.productionGraph[dependencyId] = { dependencies: [] }\n\n    const collectedDependencies: string[] = []\n    if (targetTree?.dependencies) {\n      for (const packageName in targetTree.dependencies) {\n        // Check against matching _dependencies\n        if (!this.isProdDependency(packageName, targetTree)) {\n          continue\n        }\n        const dependency = targetTree.dependencies[packageName]\n        // Match first version's empty check\n        if (Object.keys(dependency).length === 0) {\n          continue\n        }\n        const childDependencyId = this.packageVersionString({ name: packageName, version: dependency.version })\n        await this.extractProductionDependencyGraph(dependency, childDependencyId)\n        collectedDependencies.push(childDependencyId)\n      }\n    }\n    this.productionGraph[dependencyId] = { dependencies: collectedDependencies }\n  }\n\n  // Check: is package already included as a prod dependency due to another package?\n  // We need to check this to prevent infinite loops in case of duplicated dependencies\n  private isDuplicatedNpmDependency(tree: NpmDependency): boolean {\n    const { _dependencies = {}, dependencies = {} } = tree\n    const isDuplicateDep = Object.keys(_dependencies).length > 0 && Object.keys(dependencies).length === 0\n    return isDuplicateDep\n  }\n\n  // `npm list` provides explicit list of deps in _dependencies\n  protected isProdDependency(packageName: string, tree: NpmDependency) {\n    return tree._dependencies?.[packageName] != null\n  }\n}\n"]}